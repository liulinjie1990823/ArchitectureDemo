
private def uploadPGY(String filePath, String apiKey) {
    println filePath
    def stdout = new ByteArrayOutputStream()
    exec {
        executable = 'curl'
        args = ['-F', "file=@${filePath}", '-F', "_api_key=${apiKey}", rootProject.ext.pgyUploadUrl]
        standardOutput = stdout
    }
    String output = stdout.toString()
    def parsedJson = new groovy.json.JsonSlurper().parseText(output)
    println parsedJson.data.buildQRCodeURL
    println "版本号：" + parsedJson.data.buildVersion
}

private def noticeDingDing(String filePath, String apiKey) {
    println filePath
    def stdout = new ByteArrayOutputStream()
    exec {
        executable = 'curl'
        args = ['-H', "Content-Type: application/json",
                '-F', "_api_key=${apiKey}",
                '-d',
                "https://oapi.dingtalk.com/robot/send?access_token=${rootProject.ext.dingTalkAccessToken}"]
        standardOutput = stdout
    }
    String output = stdout.toString()
    def parsedJson = new groovy.json.JsonSlurper().parseText(output)
    println parsedJson.data.buildQRCodeURL
    println "版本号：" + parsedJson.data.buildVersion
}

/**
 * 执行 “uploadDebugApk” 命令自动打测试服包，并上传到蒲公英
 */
task uploadDebugApk() {
    group = "publishPgy"
    doLast {
        uploadPGY(rootProject.ext.debugFile, rootProject.ext.pgyDebugApiKey)
    }
}

tasks.whenTaskAdded { task ->
    if (task.name == 'assembleDebug') {
        uploadDebugApk.dependsOn(task)
    }
}

/**
 * 执行 “uploadBetaApk” 命令自动打正式服包，并上传到蒲公英
 */
task uploadBetaApk() {
    group = "publishPgy"
    doLast {
        uploadPGY(rootProject.ext.betaFile, rootProject.ext.pgyBetaApiKey)
    }
}

tasks.whenTaskAdded { task ->
    if (task.name == 'assembleBeta') {
        uploadBetaApk.dependsOn(task)
    }
}

/**
 * 执行 “uploadReleaseApk” 命令自动打超管服包，并上传到蒲公英
 */
task uploadReleaseApk() {
    group = "publishPgy"
    doLast {
        uploadPGY(rootProject.ext.releaseFile, rootProject.ext.pgyReleaseApiKey)
    }
}

tasks.whenTaskAdded { task ->
    if (task.name == 'assembleRelease') {
        uploadReleaseApk.dependsOn(task)
    }
}
